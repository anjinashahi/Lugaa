<?php
// Fetch data from URL parameters
$size = isset($_GET['size']) ? htmlspecialchars($_GET['size']) : '';
$quantity = isset($_GET['quantity']) ? (int) $_GET['quantity'] : 0; // Convert to integer
$description = isset($_GET['description']) ? htmlspecialchars($_GET['description']) : '';
$product_ids = isset($_GET['product_ids']) ? htmlspecialchars($_GET['product_ids']) : '';
$color = isset($_GET['color']) ? htmlspecialchars($_GET['color']) : '';
$product_image = isset($_GET['product_image']) ? htmlspecialchars($_GET['product_image']) : '';
$product_name = isset($_GET['product_name']) ? htmlspecialchars($_GET['product_name']) : '';
$discounted_price = isset($_GET['discounted_price']) ? htmlspecialchars($_GET['discounted_price']) : '';

// Example usage of the fetched data
echo '<div>
    <p>Size: ' . $size . '</p>
    <p>Description: ' . $description . '</p>
    <p>Product IDs: ' . $product_ids . '</p>
    <p>Color: ' . $color . '</p>
    <p>Product Image: ' . $product_image . '</p>
    <p>Product Name: ' . $product_name . '</p>
    <p>Discounted Price: ' . $discounted_price . '</p>
    <button class="increase" onclick="increaseQuantity()">+</button>
    <p>Quantity: <span id="quantity">' . $quantity . '</span></p>
    <button class="decrease" onclick="decreaseQuantity()">-</button>
    <p id="order_status">pending</p>
</div>';
?>

<script>
    function decreaseQuantity() {
        var quantityElement = document.getElementById('quantity');
        var currentQuantity = parseInt(quantityElement.innerText);
        if (currentQuantity > 1) {
            quantityElement.innerText = currentQuantity - 1;
        }
    }

    function increaseQuantity() {
        var quantityElement = document.getElementById('quantity');
        var currentQuantity = parseInt(quantityElement.innerText);
        quantityElement.innerText = currentQuantity + 1;
    }
</script>








<?php
session_start();

require 'connection.php';

if(isset($_SESSION['logged'])) {
    $loggedInName = $_SESSION['logged'];
    $sql_customer = "SELECT customer_id FROM customers WHERE full_name = '$loggedInName'";
    $result_customer = $conn->query($sql_customer);
    if ($result_customer && $result_customer->num_rows > 0) {
        $row_customer = $result_customer->fetch_assoc();
        $customer_id = $row_customer['customer_id'];
    } else {
        echo "No customer found for the logged-in user.";
        // Handle this case appropriately
    }
} else {
    echo "Session 'logged' is not set.";
    // Handle this case appropriately
}

// Query products with pending order status purchased by the customer
$sql_products = "SELECT * FROM order_details WHERE customer_id = '$customer_id' AND order_status = 'pending'";
$result_products = $conn->query($sql_products);

if ($result_products && $result_products->num_rows > 0) {
    echo "<h2>Products with Pending Order Status Purchased by Customer</h2>";
    while ($row_product = $result_products->fetch_assoc()) {
        // Calculate single price
        $single_price = $row_product['total'] / $row_product['quantity'];
        
        // Display product details
        echo '<div>
                <p id="size">Size: ' . $row_product['size'] . '</p>
                <p id="product_id">Product ID: ' . $row_product['product_id'] . '</p> <!-- Corrected attribute -->
                <p id="product_color">Color: ' . $row_product['color'] . '</p>
                <p id="order_status">Order Status: ' . $row_product['order_status'] . '</p> <!-- Added order status attribute -->
                <p id="total">Total: ' . $row_product['total'] . '</p> <!-- Added total attribute -->
                <p id="single_price">Single Price: ' . $single_price . '</p> <!-- Added single price -->
                <p id = "fetched_quantity">Fetched Quantity: ' .$row_product['quantity']. '</p>

                <div class="quantity">
                <button class="decrease">-</button>
                <input type="number" value="1" id="quantityInput"> <!-- Set default value to 1 -->
                <button class="increase">+</button>
                <div id="selectedQuantity" >1</div> <!-- Hide the selected quantity initially -->
                <button class="updateQuantity" onclick="updateQuantity(' . $row_product['product_id'] . ')">Update Quantity</button>
                </div>

            </div> <br> <br>';
    }
} else {
    echo "No products with pending order status found for this customer.";
}
?>
<script>
        // Function to update selected quantity
        document.querySelectorAll('.quantity .increase').forEach(button => {
            button.addEventListener('click', function() {
                var quantityInput = this.parentElement.querySelector('input[type="number"]');
                var selectedQuantity = this.parentElement.querySelector('#selectedQuantity');
                quantityInput.value = parseInt(quantityInput.value) + 1;
                selectedQuantity.innerText = quantityInput.value;
                // Show the selectedQuantity div after changing the quantity
                selectedQuantity.style.display = 'block';
                calculateNewTotal(); // Calculate new total when quantity changes
            });
        });

        document.querySelectorAll('.quantity .decrease').forEach(button => {
            button.addEventListener('click', function() {
                var quantityInput = this.parentElement.querySelector('input[type="number"]');
                var selectedQuantity = this.parentElement.querySelector('#selectedQuantity');
                if (parseInt(quantityInput.value) > 1) {
                    quantityInput.value = parseInt(quantityInput.value) - 1;
                    selectedQuantity.innerText = quantityInput.value;
                    // Show the selectedQuantity div after changing the quantity
                    selectedQuantity.style.display = 'block';
                    calculateNewTotal(); // Calculate new total when quantity changes
                }
            });
        });

        // Function to calculate new total
        function calculateNewTotal() {
            var singlePrice = parseFloat(document.getElementById('single_price').innerText);
            var quantity = parseInt(document.getElementById('quantityInput').value);
            var newTotal = singlePrice * quantity;
            document.getElementById('new_total').innerText = newTotal;
        }

        // Function to update quantity in database
        function updateQuantity(productId) {
            var newQuantity = document.getElementById('quantityInput').value;
            var newTotal = document.getElementById('new_total').innerText;
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    // Quantity updated successfully
                    alert("Quantity updated successfully!");
                }
            };
            xhttp.open("POST", "update_quantity.php", true);
            xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhttp.send("product_id=" + productId + "&quantity=" + newQuantity + "&total=" + newTotal);
        }
</script>
